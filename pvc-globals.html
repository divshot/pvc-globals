<link rel="import" href="../polymer/polymer.html">
<script src="../observe-js/src/observe.js"></script>

<!--
Document-wide globals with instant cross-element propagation.

##### Example

    <pvc-globals namespace="org" values="{{globals}}"></pvc-globals>

Globals are shared across all instances of the `pvc-globals` element, so
changing a value in one will be reflected in every other element with the
same namespace.

You can bind to the values directly, but you can also listen for events.
Each element will trigger a `pvc-globals-*` event with `*` being one of
`add`, `remove`, `change`, or `update`. The `update` event fires when
any of the other events happens and includes an `event` key in its detail
to tell you which.

    <pvc-globals on-pvc-globals-update="{{handleUpdate}}"></pvc-globals>

If you need to observe deeply nested global properties, you can register
them using the standard Polymer observe:

    <polymer-element name="globals-watcher">
      <template>
        <pvc-globals id='globals'></pvc-globals>
      </template>
      <script>
        Polymer('globals-watcher', {
          observe: {
            '$.globals.values.deep.key.to.watch': 'deepChange'
          },
          deepChange: function(){
            // ...
          }
        });
      </script>
    </polymer-element>

@element pvc-globals
@demo demo/index.html
@blurb Document-wide globals with instant cross-element propagation.
@status alpha
@homepage http://code.divshot.com/pvc-globals
-->
<dom-module id="pvc-globals">
  <script>
    (function () {
      Polymer({
        is: 'pvc-globals',
        properties: {
          /**
           * The (optional) `namespace` attribute lets you have multiple
           * scopes of globals.
           *
           * @attribute namespace
           * @type string
           */
          namespace: {
            type: String,
            notify: true
          },

          /**
           * The `values` attribute is an object containing the set globals for
           * the current namespace. You can bind to this.
           */
          values: {
            type: Object,
            notify: true
          },

          _instances: {
            type: Array,
            value: []
          },

          _globals: {
            type: Object,
            value: {}
          },

          _observers: {
            type: Array,
            value: []
          }
        },

        observers: [
          '_initObserver(values.*)'
        ],

        attached: function() {
          this.push('_instances', this);
        },

        _initObserver: function(change) {
          if (!this._globals[this.namespace || '__default'] && change.path === 'values') {
            this._makeAndObserve(this.namespace || '__default', this.values);
          }
        },

        _makeAndObserve: function(namespace, values) {
          this._globals[namespace] || (this._globals[namespace] = values || {});
          this._observers[namespace] = new ObjectObserver(this._globals[namespace]);
          this._observers[namespace].open(function (a, r, c, o) {
            this._observeFn(namespace, a, r, c, o);
          }.bind(this));
          return this._globals[namespace];
        },

        _observeFn: function(namespace, added, removed, changed, getOldValueFn) {
          if (namespace === '__default') {
            namespace = undefined;
          }
          console.log(added);
          Object.keys(added).forEach(function (prop) {
            var detail = {
              event: 'add',
              namespace: namespace,
              property: prop,
              value: added[prop],
              oldValue: getOldValueFn(prop)
            };
            this._fire('pvc-globals-update', detail);
            this._fire('pvc-globals-add', detail);
          }.bind(this));
          Object.keys(removed).forEach(function (prop) {
            var detail = {
              event: 'remove',
              namespace: namespace,
              property: prop,
              value: undefined,
              oldValue: getOldValueFn(prop)
            };
            this._fire('pvc-globals-update', detail);
            this._fire('pvc-globals-remove', detail);
          }.bind(this));
          Object.keys(changed).forEach(function (prop) {
            var detail = {
              event: 'change',
              namespace: namespace,
              property: prop,
              value: changed[prop],
              oldValue: getOldValueFn(prop)
            };
            this._fire('pvc-globals-update', detail);
            this._fire('pvc-globals-change', detail);
          }.bind(this));
        },

        _fire: function(name, detail) {
          this._instances.forEach(function (instance) {
            if (instance.namespace === detail.namespace) {
              instance.setAttribute('values', this.values);
              instance.fire(name, detail);
            }
          }.bind(this));
        }
        /**
          * The `pvc-globals-change` event is fired on each element whenever a
          * global variable is added. The detail is an object including the
          * `namespace`, `property`, `value`, and `oldValue`.
          *
          * @event pvc-globals-add
          */
         /**
          * The `pvc-globals-change` event is fired on each element whenever a
          * global variable is removed. The detail is an object including the
          * `namespace`, `property`, `value`, and `oldValue`.
          *
          * @event pvc-globals-remove
          */
         /**
          * The `pvc-globals-change` event is fired on each element whenever a
          * global variable is modified. The detail is an object including the
          * `namespace`, `property`, `value`, `oldValue`.
          *
          * @event pvc-globals-change
          */
         /**
          * The `pvc-globals-update` event is fired on each element whenever any
          * kind of alteration (add, remove, change) is made. The detail is an
          * object including the `namespace`, `property`, `value`, `oldValue`.
          *
          * @event pvc-globals-update
          */
      });
    }());
  </script>
</dom-module>
